name: Generate PDFs

on:
  push:
    branches:
      - master
    # Run the workflow only when the markdown files or the workflow itself are changed
    paths:
      - 'resume/markdown/*.md'
      - '.github/workflows/simplified_pdfs.yaml'

jobs:
  generate_pdfs:
    runs-on: ubuntu-latest

    steps:
    - name: Cache Pandoc and Weasyprint Dependencies
      uses: actions/cache@v3
      with:
        path: /usr/local/bin/weasyprint  # Adjust this to the correct path for weasyprint and pandoc
        key: weasyprint-pandoc-dependencies-cache

    - name: Installing Dependencies (only if not cached)
      run: |
        sudo apt update
        sudo apt install -y weasyprint pandoc
        
    - name: Checking out repository (fetch the last 2 commits)
      uses: actions/checkout@v3
      with:
        fetch-depth: 2  # Fetch the latest two commits to allow diffing with HEAD^
    
    - name: Generating PDFs (only for modified files)
      run: |
        CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep '\.md$')
        for i in $CHANGED_FILES; do 
          echo "Processing $i" 
          pandoc $i -o "${i%.md}.html" 
          weasyprint "${i%.md}.html" "${i%.md}.pdf"
        done

    - name: Committing and pushing PDFs
      uses: test-room-7/action-update-file@v1
      with:
        file-path: |
            resume/simplified/cv-en.pdf
            resume/simplified/cv-pt.pdf
        commit-msg: Update pdfs
        github-token: ${{ secrets.GITHUB_TOKEN }}
